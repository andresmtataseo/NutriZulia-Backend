# üìã Plan de Implementaci√≥n del Sistema de Sincronizaci√≥n - NutriZulia Backend

## üéØ Objetivo General
Implementar un sistema de sincronizaci√≥n bidireccional completo que permita a la aplicaci√≥n m√≥vil Android sincronizar datos de manera eficiente y confiable con el servidor backend.

## üîç An√°lisis del Estado Actual

### ‚úÖ Fortalezas Identificadas
- **Arquitectura Spring Boot 3.5.0** con Java 21 establecida
- **Autenticaci√≥n JWT** completamente implementada y funcional
- **Base de datos PostgreSQL** configurada
- **Entidades JPA** bien estructuradas con relaciones definidas
- **Campo `updated_at`** ya presente en las entidades principales
- **MapStruct** configurado para mapeo de DTOs
- **Swagger/OpenAPI** para documentaci√≥n de API

### ‚ö†Ô∏è Gaps Identificados
- **Falta campo `created_at`** en las entidades
- **No existen endpoints de sincronizaci√≥n**
- **Falta l√≥gica de UPSERT** para sincronizaci√≥n bidireccional
- **No hay DTOs espec√≠ficos** para operaciones de sincronizaci√≥n
- **Faltan √≠ndices de base de datos** para optimizaci√≥n de consultas
- **No hay triggers** para actualizaci√≥n autom√°tica de timestamps
- **Falta sistema de rate limiting** para endpoints de sincronizaci√≥n

---

## üöÄ Plan de Implementaci√≥n por Fases

### **FASE 1: Preparaci√≥n de Base de Datos y Entidades** ‚è±Ô∏è (2-3 d√≠as)

#### 1.1 Creaci√≥n de Clase Base para Entidades
**Objetivo**: Centralizar campos comunes de auditor√≠a

**Archivos a crear:**
- `src/main/java/com/nutrizulia/common/entity/BaseEntity.java`

**Funcionalidades:**
```java
@MappedSuperclass
public abstract class BaseEntity {
    @CreationTimestamp
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
}
```

#### 1.2 Modificaci√≥n del Esquema de Entidades
**Archivos a modificar:**
- `src/main/java/com/nutrizulia/collection/model/Paciente.java`
- `src/main/java/com/nutrizulia/collection/model/Representante.java`
- `src/main/java/com/nutrizulia/collection/model/Consulta.java`
- `src/main/java/com/nutrizulia/collection/model/DetalleAntropometrico.java`
- `src/main/java/com/nutrizulia/collection/model/DetalleVital.java`
- `src/main/java/com/nutrizulia/collection/model/DetalleMetabolico.java`
- `src/main/java/com/nutrizulia/collection/model/DetallePedriatrico.java`
- `src/main/java/com/nutrizulia/collection/model/DetalleObstetricia.java`
- `src/main/java/com/nutrizulia/collection/model/EvaluacionAntropometrica.java`
- `src/main/java/com/nutrizulia/collection/model/Diagnostico.java`
- `src/main/java/com/nutrizulia/collection/model/PacienteRepresentante.java`
- `src/main/java/com/nutrizulia/collection/model/Actividad.java`

**Tareas:**
1. ‚úÖ Extender de `BaseEntity` todas las entidades principales
2. ‚úÖ Remover campos `updatedAt` duplicados
3. ‚úÖ Agregar anotaciones `@PrePersist` y `@PreUpdate` si es necesario
4. ‚úÖ Validar que todas las relaciones mantengan consistencia

#### 1.3 Scripts de Migraci√≥n de Base de Datos
**Archivos a crear:**
- `src/main/resources/db/migration/V2__add_created_at_fields.sql`
- `src/main/resources/db/migration/V3__add_sync_indexes.sql`
- `src/main/resources/db/migration/V4__add_sync_triggers.sql`

**Contenido de migraciones:**
```sql
-- V2: Agregar campos created_at
ALTER TABLE pacientes ADD COLUMN IF NOT EXISTS created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE representantes ADD COLUMN IF NOT EXISTS created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;
-- ... para todas las tablas

-- V3: Crear √≠ndices de rendimiento
CREATE INDEX IF NOT EXISTS idx_pacientes_updated_at ON pacientes(updated_at);
CREATE INDEX IF NOT EXISTS idx_pacientes_user_updated ON pacientes(usuario_institucion_id, updated_at);
-- ... para todas las tablas

-- V4: Triggers de actualizaci√≥n autom√°tica
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';
```

#### 1.4 Configuraci√≥n de Flyway
**Archivo a modificar:**
- `src/main/resources/application.properties` o `application.yml`

**Configuraci√≥n:**
```properties
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true
```

---

### **FASE 2: DTOs y Mappers de Sincronizaci√≥n** ‚è±Ô∏è (1-2 d√≠as)

#### 2.1 DTOs Principales de Sincronizaci√≥n
**Archivos a crear:**
- `src/main/java/com/nutrizulia/sync/dto/SyncPushRequestDto.java`
- `src/main/java/com/nutrizulia/sync/dto/SyncPullResponseDto.java`
- `src/main/java/com/nutrizulia/sync/dto/SyncResultDto.java`
- `src/main/java/com/nutrizulia/sync/dto/SyncStatsDto.java`

**Estructura del SyncPushRequestDto:**
```java
public class SyncPushRequestDto {
    private List<PacienteSyncDto> pacientes;
    private List<RepresentanteSyncDto> representantes;
    private List<ConsultaSyncDto> consultas;
    private List<DetalleAntropometricoSyncDto> detallesAntropometricos;
    // ... m√°s entidades
}
```

#### 2.2 DTOs Espec√≠ficos por Entidad
**Archivos a crear:**
- `src/main/java/com/nutrizulia/sync/dto/entity/PacienteSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/RepresentanteSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/ConsultaSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/DetalleAntropometricoSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/DetalleVitalSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/DetalleMetabolicoSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/DetallePedriatricoSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/DetalleObstetriciaSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/EvaluacionAntropometricaSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/DiagnosticoSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/PacienteRepresentanteSyncDto.java`
- `src/main/java/com/nutrizulia/sync/dto/entity/ActividadSyncDto.java`

#### 2.3 Mappers de Sincronizaci√≥n
**Archivos a crear:**
- `src/main/java/com/nutrizulia/sync/mapper/SyncMapper.java`
- `src/main/java/com/nutrizulia/sync/mapper/PacienteSyncMapper.java`
- `src/main/java/com/nutrizulia/sync/mapper/ConsultaSyncMapper.java`
- Mappers espec√≠ficos para cada entidad

**Ejemplo de mapper:**
```java
@Mapper(componentModel = "spring")
public interface PacienteSyncMapper {
    PacienteSyncDto toSyncDto(Paciente paciente);
    Paciente toEntity(PacienteSyncDto dto);
    List<PacienteSyncDto> toSyncDtoList(List<Paciente> pacientes);
}
```

---

### **FASE 3: Servicios de Sincronizaci√≥n** ‚è±Ô∏è (3-4 d√≠as)

#### 3.1 Interfaces de Servicio
**Archivos a crear:**
- `src/main/java/com/nutrizulia/sync/service/ISyncService.java`
- `src/main/java/com/nutrizulia/sync/service/ISyncEntityService.java`

**Interface principal:**
```java
public interface ISyncService {
    SyncResultDto pushChanges(SyncPushRequestDto request, UUID usuarioInstitucionId);
    SyncPullResponseDto pullChanges(LocalDateTime since, UUID usuarioInstitucionId);
    void validateSyncData(SyncPushRequestDto request);
    SyncStatsDto getSyncStats(UUID usuarioInstitucionId);
}
```

#### 3.2 Servicio Principal de Sincronizaci√≥n
**Archivo a crear:**
- `src/main/java/com/nutrizulia/sync/service/SyncService.java`

**Funcionalidades principales:**
- Coordinaci√≥n de operaciones PUSH/PULL
- Manejo de transacciones at√≥micas
- Validaci√≥n de datos de entrada
- Generaci√≥n de estad√≠sticas de sincronizaci√≥n
- Manejo de errores y rollback

#### 3.3 Servicios Espec√≠ficos por Entidad
**Archivos a crear:**
- `src/main/java/com/nutrizulia/sync/service/entity/PacienteSyncService.java`
- `src/main/java/com/nutrizulia/sync/service/entity/RepresentanteSyncService.java`
- `src/main/java/com/nutrizulia/sync/service/entity/ConsultaSyncService.java`
- Servicios para cada entidad con l√≥gica UPSERT espec√≠fica

**Funcionalidades por servicio:**
```java
public interface ISyncEntityService<T, D> {
    List<T> upsertEntities(List<D> dtos, UUID usuarioInstitucionId);
    List<T> findModifiedSince(LocalDateTime since, UUID usuarioInstitucionId);
    void validateEntityData(List<D> dtos);
}
```

#### 3.4 Repositorios Extendidos
**Archivos a modificar:**
- Todos los repositorios en `src/main/java/com/nutrizulia/collection/repository/`

**M√©todos a agregar:**
```java
@Query("SELECT e FROM EntityName e WHERE e.usuarioInstitucion.id = :usuarioInstitucionId AND e.updatedAt > :since ORDER BY e.updatedAt ASC")
List<EntityName> findModifiedSince(@Param("usuarioInstitucionId") UUID usuarioInstitucionId, 
                                  @Param("since") LocalDateTime since);

@Modifying
@Query("INSERT INTO EntityName (...) VALUES (...) ON CONFLICT (id) DO UPDATE SET ...")
void upsertEntity(@Param("entity") EntityName entity);
```

---

### **FASE 4: Controladores de Sincronizaci√≥n** ‚è±Ô∏è (1-2 d√≠as)

#### 4.1 Controlador Principal
**Archivo a crear:**
- `src/main/java/com/nutrizulia/sync/controller/SyncController.java`

**Endpoints a implementar:**
```java
@RestController
@RequestMapping("/api/sync")
@Validated
@SecurityRequirement(name = "bearerAuth")
public class SyncController {
    
    @PostMapping("/push")
    @Operation(summary = "Enviar cambios al servidor")
    public ResponseEntity<SyncResultDto> pushChanges(
        @Valid @RequestBody SyncPushRequestDto request,
        Authentication authentication
    );
    
    @GetMapping("/pull")
    @Operation(summary = "Obtener cambios del servidor")
    public ResponseEntity<SyncPullResponseDto> pullChanges(
        @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime since,
        @RequestParam(defaultValue = "1000") @Min(1) @Max(5000) int limit,
        Authentication authentication
    );
    
    @GetMapping("/stats")
    @Operation(summary = "Obtener estad√≠sticas de sincronizaci√≥n")
    public ResponseEntity<SyncStatsDto> getSyncStats(Authentication authentication);
}
```

#### 4.2 Manejo de Errores Espec√≠ficos
**Archivo a crear:**
- `src/main/java/com/nutrizulia/sync/exception/SyncExceptionHandler.java`

**Excepciones a manejar:**
- `SyncValidationException`
- `SyncConflictException`
- `SyncTimeoutException`
- `SyncDataIntegrityException`

---

### **FASE 5: Seguridad y Validaciones** ‚è±Ô∏è (1-2 d√≠as)

#### 5.1 Configuraci√≥n de Seguridad
**Archivo a modificar:**
- `src/main/java/com/nutrizulia/common/config/SecurityConfig.java`

**Modificaciones:**
```java
.requestMatchers("/api/sync/**").authenticated()
.requestMatchers(HttpMethod.POST, "/api/sync/push").hasRole("SYNC_WRITE")
.requestMatchers(HttpMethod.GET, "/api/sync/pull").hasRole("SYNC_READ")
```

#### 5.2 Rate Limiting
**Archivo a crear:**
- `src/main/java/com/nutrizulia/sync/config/RateLimitConfig.java`
- `src/main/java/com/nutrizulia/sync/aspect/RateLimitAspect.java`

**Configuraci√≥n:**
- 10 requests por minuto para endpoints de sincronizaci√≥n
- L√≠mites diferenciados por tipo de operaci√≥n (PUSH vs PULL)
- Bloqueo temporal por abuso

#### 5.3 Validadores Personalizados
**Archivos a crear:**
- `src/main/java/com/nutrizulia/sync/validator/SyncDataValidator.java`
- `src/main/java/com/nutrizulia/sync/validator/TimestampValidator.java`
- `src/main/java/com/nutrizulia/sync/validator/UUIDValidator.java`
- `src/main/java/com/nutrizulia/sync/validator/RelationshipValidator.java`

**Validaciones a implementar:**
- Formato de UUIDs
- Consistencia de timestamps
- Integridad referencial
- L√≠mites de tama√±o de payload
- Validaci√≥n de permisos por instituci√≥n

---

### **FASE 6: Optimizaciones y Monitoreo** ‚è±Ô∏è (2-3 d√≠as)

#### 6.1 Configuraci√≥n de Performance
**Archivos a crear:**
- `src/main/java/com/nutrizulia/sync/config/SyncConfig.java`
- `src/main/java/com/nutrizulia/sync/config/CacheConfig.java`

**Optimizaciones:**
```java
@Configuration
public class SyncConfig {
    @Bean
    @ConfigurationProperties("sync.performance")
    public SyncPerformanceProperties syncProperties() {
        return new SyncPerformanceProperties();
    }
    
    @Bean
    public TaskExecutor syncTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        return executor;
    }
}
```

#### 6.2 Sistema de Cache
**Implementaci√≥n:**
- Cache de consultas frecuentes con Redis/Caffeine
- Cache de metadatos de sincronizaci√≥n
- Invalidaci√≥n inteligente de cache

#### 6.3 Logging y M√©tricas
**Archivos a crear:**
- `src/main/java/com/nutrizulia/sync/aspect/SyncLoggingAspect.java`
- `src/main/java/com/nutrizulia/sync/metrics/SyncMetrics.java`

**M√©tricas a capturar:**
- Tiempo de respuesta por endpoint
- Volumen de datos sincronizados
- Frecuencia de sincronizaci√≥n por usuario
- Tasa de errores y tipos de error
- Uso de recursos (CPU, memoria, DB connections)

#### 6.4 Health Checks
**Archivo a crear:**
- `src/main/java/com/nutrizulia/sync/health/SyncHealthIndicator.java`

**Verificaciones:**
- Conectividad a base de datos
- Estado de servicios de sincronizaci√≥n
- Latencia de operaciones cr√≠ticas

---

### **FASE 7: Testing y Documentaci√≥n** ‚è±Ô∏è (2-3 d√≠as)

#### 7.1 Tests Unitarios
**Archivos a crear:**
- `src/test/java/com/nutrizulia/sync/service/SyncServiceTest.java`
- `src/test/java/com/nutrizulia/sync/service/PacienteSyncServiceTest.java`
- `src/test/java/com/nutrizulia/sync/controller/SyncControllerTest.java`
- `src/test/java/com/nutrizulia/sync/mapper/SyncMapperTest.java`
- `src/test/java/com/nutrizulia/sync/validator/SyncValidatorTest.java`

**Cobertura objetivo:** >80%

#### 7.2 Tests de Integraci√≥n
**Archivos a crear:**
- `src/test/java/com/nutrizulia/sync/integration/SyncIntegrationTest.java`
- `src/test/java/com/nutrizulia/sync/integration/SyncPerformanceTest.java`
- `src/test/java/com/nutrizulia/sync/integration/SyncSecurityTest.java`

**Escenarios a probar:**
- Sincronizaci√≥n completa end-to-end
- Manejo de conflictos de datos
- Comportamiento bajo carga
- Seguridad y autenticaci√≥n
- Recuperaci√≥n ante fallos

#### 7.3 Tests de Carga
**Herramientas:** JMeter o Gatling
**Escenarios:**
- 100 usuarios concurrentes sincronizando
- Payloads de diferentes tama√±os
- Sincronizaci√≥n de 10,000+ registros

#### 7.4 Documentaci√≥n
**Archivos a crear:**
- `docs/SYNC_API_GUIDE.md` - Gu√≠a de uso de la API
- `docs/SYNC_TROUBLESHOOTING.md` - Gu√≠a de resoluci√≥n de problemas
- `docs/SYNC_PERFORMANCE_TUNING.md` - Gu√≠a de optimizaci√≥n
- `docs/SYNC_DEPLOYMENT.md` - Gu√≠a de despliegue

**Documentaci√≥n Swagger:**
- Ejemplos de requests/responses
- C√≥digos de error detallados
- Gu√≠as de autenticaci√≥n

---

## üõ†Ô∏è Estructura Final de Archivos

```
src/main/java/com/nutrizulia/
‚îú‚îÄ‚îÄ sync/
‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SyncController.java
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncPushRequestDto.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncPullResponseDto.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncResultDto.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncStatsDto.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entity/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ PacienteSyncDto.java
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ RepresentanteSyncDto.java
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ConsultaSyncDto.java
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ... (m√°s DTOs por entidad)
‚îÇ   ‚îú‚îÄ‚îÄ mapper/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncMapper.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PacienteSyncMapper.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (m√°s mappers)
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ISyncService.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncService.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ISyncEntityService.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entity/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ PacienteSyncService.java
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ RepresentanteSyncService.java
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ... (m√°s servicios)
‚îÇ   ‚îú‚îÄ‚îÄ validator/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncDataValidator.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TimestampValidator.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UUIDValidator.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RelationshipValidator.java
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncConfig.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RateLimitConfig.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CacheConfig.java
‚îÇ   ‚îú‚îÄ‚îÄ aspect/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncLoggingAspect.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RateLimitAspect.java
‚îÇ   ‚îú‚îÄ‚îÄ exception/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncException.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncValidationException.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SyncConflictException.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SyncExceptionHandler.java
‚îÇ   ‚îú‚îÄ‚îÄ metrics/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SyncMetrics.java
‚îÇ   ‚îî‚îÄ‚îÄ health/
‚îÇ       ‚îî‚îÄ‚îÄ SyncHealthIndicator.java
‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ entity/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BaseEntity.java
‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îÇ       ‚îî‚îÄ‚îÄ SecurityConfig.java (modificado)
‚îî‚îÄ‚îÄ collection/
    ‚îú‚îÄ‚îÄ model/ (entidades modificadas)
    ‚îî‚îÄ‚îÄ repository/ (repositorios extendidos)

src/main/resources/
‚îú‚îÄ‚îÄ db/migration/
‚îÇ   ‚îú‚îÄ‚îÄ V2__add_created_at_fields.sql
‚îÇ   ‚îú‚îÄ‚îÄ V3__add_sync_indexes.sql
‚îÇ   ‚îî‚îÄ‚îÄ V4__add_sync_triggers.sql
‚îî‚îÄ‚îÄ application.yml (configuraci√≥n actualizada)

docs/
‚îú‚îÄ‚îÄ SYNC_API_GUIDE.md
‚îú‚îÄ‚îÄ SYNC_TROUBLESHOOTING.md
‚îú‚îÄ‚îÄ SYNC_PERFORMANCE_TUNING.md
‚îî‚îÄ‚îÄ SYNC_DEPLOYMENT.md
```

---

## üìä Dependencias Adicionales Requeridas

### Agregar al `pom.xml`:
```xml
<!-- Rate Limiting -->
<dependency>
    <groupId>com.github.vladimir-bukhtoyarov</groupId>
    <artifactId>bucket4j-core</artifactId>
    <version>7.6.0</version>
</dependency>

<!-- M√©tricas y Monitoreo -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>

<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>

<!-- Migraciones de Base de Datos -->
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>

<!-- Cache -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-cache</artifactId>
</dependency>

<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
</dependency>

<!-- Testing -->
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>postgresql</artifactId>
    <scope>test</scope>
</dependency>

<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>junit-jupiter</artifactId>
    <scope>test</scope>
</dependency>
```

---

## ‚ö° Consideraciones T√©cnicas Cr√≠ticas

### 1. **Estrategia de UPSERT**
```sql
INSERT INTO pacientes (id, nombres, apellidos, ..., updated_at) 
VALUES (?, ?, ?, ..., ?) 
ON CONFLICT (id) 
DO UPDATE SET 
    nombres = EXCLUDED.nombres,
    apellidos = EXCLUDED.apellidos,
    updated_at = EXCLUDED.updated_at
WHERE pacientes.updated_at < EXCLUDED.updated_at;
```

### 2. **Manejo de Transacciones**
- Usar `@Transactional(propagation = Propagation.REQUIRED)`
- Implementar savepoints para rollback parcial
- Timeout de 30 segundos para operaciones de sincronizaci√≥n

### 3. **Optimizaci√≥n de Consultas**
- √çndices compuestos: `(usuario_institucion_id, updated_at)`
- Paginaci√≥n con cursor-based pagination
- Uso de `@EntityGraph` para cargar relaciones eficientemente

### 4. **Seguridad**
- Validaci√≥n de ownership: datos pertenecen al usuario autenticado
- Sanitizaci√≥n de inputs con OWASP Java Encoder
- Rate limiting: 10 requests/minuto por usuario
- Logging de todas las operaciones de sincronizaci√≥n

### 5. **Manejo de Errores**
- Retry autom√°tico para errores transitorios
- Circuit breaker para proteger la base de datos
- Fallback a modo offline en caso de fallos cr√≠ticos

---

## üéØ Criterios de Aceptaci√≥n

### Funcionales
- ‚úÖ Endpoint PUSH procesa correctamente datos del cliente m√≥vil
- ‚úÖ Endpoint PULL retorna cambios incrementales desde timestamp
- ‚úÖ Resoluci√≥n de conflictos basada en timestamp del servidor
- ‚úÖ Manejo de relaciones entre entidades (foreign keys)
- ‚úÖ Validaci√≥n de integridad de datos
- ‚úÖ Autenticaci√≥n JWT integrada y funcional

### No Funcionales
- ‚úÖ Tiempo de respuesta < 2 segundos para 1000 registros
- ‚úÖ Throughput > 100 requests/segundo
- ‚úÖ Cobertura de tests > 80%
- ‚úÖ Zero downtime durante deployment
- ‚úÖ Logs estructurados para monitoreo
- ‚úÖ M√©tricas de performance disponibles
- ‚úÖ Documentaci√≥n completa de API

### Seguridad
- ‚úÖ Rate limiting implementado y funcional
- ‚úÖ Validaci√≥n de permisos por instituci√≥n
- ‚úÖ Sanitizaci√≥n de inputs
- ‚úÖ Logging de operaciones sensibles
- ‚úÖ Manejo seguro de errores (sin exposici√≥n de datos)

---

## üìÖ Timeline Detallado

| Fase | Duraci√≥n | Recursos | Dependencias | Entregables |
|------|----------|----------|--------------|-------------|
| **Fase 1** | 2-3 d√≠as | 1 Dev Backend | - | BaseEntity, Migraciones DB, Entidades actualizadas |
| **Fase 2** | 1-2 d√≠as | 1 Dev Backend | Fase 1 | DTOs de sincronizaci√≥n, Mappers |
| **Fase 3** | 3-4 d√≠as | 1-2 Dev Backend | Fase 2 | Servicios de sincronizaci√≥n, L√≥gica UPSERT |
| **Fase 4** | 1-2 d√≠as | 1 Dev Backend | Fase 3 | Controladores REST, Endpoints funcionales |
| **Fase 5** | 1-2 d√≠as | 1 Dev Backend + 1 DevOps | Fase 4 | Seguridad, Rate limiting, Validaciones |
| **Fase 6** | 2-3 d√≠as | 1 Dev Backend + 1 DevOps | Fase 5 | Optimizaciones, M√©tricas, Monitoreo |
| **Fase 7** | 2-3 d√≠as | 1 Dev Backend + 1 QA | Fase 6 | Tests, Documentaci√≥n, Validaci√≥n final |

**Total estimado: 12-19 d√≠as de desarrollo**

---

## üö¶ Hitos y Checkpoints

### Checkpoint 1 (Final Fase 3)
- ‚úÖ Servicios de sincronizaci√≥n funcionando
- ‚úÖ Tests unitarios b√°sicos pasando
- ‚úÖ Validaci√≥n con datos de prueba

### Checkpoint 2 (Final Fase 5)
- ‚úÖ Endpoints REST funcionales
- ‚úÖ Seguridad implementada
- ‚úÖ Tests de integraci√≥n b√°sicos

### Checkpoint 3 (Final Fase 7)
- ‚úÖ Sistema completo funcional
- ‚úÖ Performance validada
- ‚úÖ Documentaci√≥n completa
- ‚úÖ Ready for production

---

## üìû Contacto y Soporte

Para dudas o consultas durante la implementaci√≥n:
- **Arquitecto de Software**: [Nombre]
- **Lead Backend**: [Nombre]
- **DevOps**: [Nombre]
- **QA Lead**: [Nombre]

---

*Documento creado el: [Fecha]*  
*√öltima actualizaci√≥n: [Fecha]*  
*Versi√≥n: 1.0*